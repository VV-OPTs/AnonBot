<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ä¼ªåŒ¿åæé—®ç®±ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;}
        body {min-height: 100vh;background: linear-gradient(145deg, #0e121c 0%, #1b212f 100%);display: flex;align-items: center;justify-content: center;
            padding: 1rem;}
        .generator {max-width: 1400px;width: 100%;
            background: rgba(16, 20, 28, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 2rem;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;overflow: hidden;padding: 1.5rem 1.5rem 1rem 1.5rem;border: 1px solid rgba(255, 255, 255, 0.08);transition: background 0.2s;}

        /* ä¸»é¢˜å˜é‡ */
        :root {--theme-primary: #4e42a5;--theme-secondary: #a154b5;
            --theme-card-bg: #1a1f35;--theme-border: #3a4370;
            --theme-text: #e7ddff;--theme-accent: #8d79d9;}
        .theme-default {
            --theme-primary: #4e42a5;
            --theme-secondary: #a154b5;
            --theme-card-bg: #1a1f35;
            --theme-border: #3a4370;
            --theme-text: #e7ddff;
            --theme-accent: #8d79d9;}
        .theme-ocean {--theme-primary: #2c5f8a;
            --theme-secondary: #4a9ea8;--theme-card-bg: #173e4f;--theme-border: #2f7a8c;
            --theme-text: #c0e6f0;--theme-accent: #5bc0be;}
        .theme-forest {
            --theme-primary: #2d6a4f;--theme-secondary: #52b788;
            --theme-card-bg: #1b3b2b;--theme-border: #40916c;
            --theme-text: #d8f3dc;--theme-accent: #74c69d;}
        .theme-sunset {--theme-primary: #b23b5e;--theme-secondary: #d47b8c;
            --theme-card-bg: #4f2d3f;--theme-border: #b56576;--theme-text: #ffe5ec;
            --theme-accent: #e5989b;}
        .theme-midnight {--theme-primary: #3b2e6b;--theme-secondary: #5d4e9c;
            --theme-card-bg: #1e1a3a;--theme-border: #4a3f7a;--theme-text: #d2c9ff;
            --theme-accent: #7b6cd9;}

        /* èº«ä»½åŒºåŸŸ */
        .identity-section {margin-bottom: 1.5rem;background: rgba(12, 16, 26, 0.6);
            border-radius: 1.5rem;padding: 1rem 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);}
        .identity-row {display: flex;align-items: center;gap: 1rem;flex-wrap: wrap;}
        .avatar-upload-area {display: flex;align-items: center;gap: 0.8rem;flex-wrap: wrap;}
        .avatar-preview {width: 70px;height: 70px;border-radius: 25px;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));display: flex;align-items: center;justify-content: center;
            font-size: 2rem;color: white;text-shadow: 0 2px 5px rgba(0,0,0,0.4);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255,255,240,0.25);background-size: cover;
            background-position: center;flex-shrink: 0;}
        .upload-btn-wrapper {position: relative;overflow: hidden;
            background: var(--theme-card-bg);border-radius: 40px;padding: 0.5rem 1.2rem;
            color: var(--theme-text);font-weight: 500;font-size: 0.85rem;
            border: 1px solid var(--theme-border);cursor: pointer;
            white-space: nowrap;}
        .upload-btn-wrapper:hover {filter: brightness(1.2);}
        .upload-btn-wrapper input {position: absolute;left: 0;
            top: 0;opacity: 0;width: 100%;height: 100%;cursor: pointer;}
        .name-field {flex: 1;min-width: 200px;}
        .name-field label {color: var(--theme-text);opacity: 0.8;
            font-size: 0.75rem;letter-spacing: 1px;display: block;
            margin-bottom: 0.2rem;}
        .name-field input {background: #0f1426;border: 1px solid var(--theme-border);
            border-radius: 40px;padding: 0.6rem 1.2rem;color: white;
            font-size: 1rem;font-weight: 600;width: 100%;outline: none;}

        /* ä¸»é¢˜é€‰æ‹©å™¨ */
        .theme-selector {display: flex;align-items: center;gap: 0.8rem;
            margin-top: 1rem;padding-top: 0.8rem;
            border-top: 1px dashed var(--theme-border);flex-wrap: wrap;}
        .theme-selector label {color: var(--theme-text);font-size: 0.85rem;}
        .theme-options {display: flex;gap: 0.4rem;flex-wrap: wrap;}
        .theme-chip {width: 28px;height: 28px;border-radius: 50%;cursor: pointer;
            border: 2px solid transparent;transition: 0.1s;flex-shrink: 0;}
        .theme-chip.selected {border-color: white;box-shadow: 0 0 0 2px var(--theme-accent);}
        
        /* ä¸»é¢˜è‰²å— */
        .chip-default {background: linear-gradient(135deg, #4e42a5, #a154b5);}
        .chip-ocean {background: linear-gradient(135deg, #2c5f8a, #4a9ea8);}
        .chip-forest {background: linear-gradient(135deg, #2d6a4f, #52b788);}
        .chip-sunset {background: linear-gradient(135deg, #b23b5e, #d47b8c);}
        .chip-midnight {background: linear-gradient(135deg, #3b2e6b, #5d4e9c);}

        /* è§’è‰²ä¿¡æ¯å¡ç‰‡ */
        .profile-card-toggle {display: flex;align-items: center;gap: 1rem;
            margin-top: 1rem;padding-top: 0.8rem;
            border-top: 1px dashed var(--theme-border);
            flex-wrap: wrap;}
        .toggle-switch {display: flex;align-items: center;gap: 0.8rem;}
        .toggle-switch label {color: var(--theme-text);font-size: 0.85rem;white-space: nowrap;}
        .toggle-switch input {width: 44px;height: 22px;appearance: none;
            background: var(--theme-card-bg);border-radius: 30px;
            border: 1px solid var(--theme-border);position: relative;cursor: pointer;
            flex-shrink: 0;}
        .toggle-switch input:checked {background: var(--theme-primary);}
        .toggle-switch input::before {content: '';position: absolute;width: 18px;height: 18px;
            background: white;border-radius: 50%;top: 1px;left: 2px;
            transition: 0.1s;}
        .toggle-switch input:checked::before {left: 22px;}
        .profile-card {background: var(--theme-card-bg);border-radius: 1.5rem;
            padding: 1rem 1.2rem;margin-top: 1rem;
            border: 1px solid var(--theme-border);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4);
            display: flex;align-items: center;gap: 1rem;flex-wrap: wrap;}
        .profile-card.hidden {display: none;}
        .profile-avatar-mini {width: 48px;height: 48px;border-radius: 20px;
            background: var(--theme-primary);background-size: cover;
            background-position: center;flex-shrink: 0;
            border: 2px solid var(--theme-accent);}
        .profile-text {flex: 1;min-width: 150px;}
        .profile-name {font-weight: 700;font-size: 1.1rem;color: var(--theme-text);}
        .profile-signature {color: var(--theme-text);opacity: 0.8;
            font-size: 0.85rem;margin-top: 0.2rem;word-break: break-word;}
        .edit-signature {background: var(--theme-primary);border: none;
            color: white;padding: 0.2rem 1rem;
            border-radius: 30px;font-size: 0.75rem;
            cursor: pointer;border: 1px solid var(--theme-accent);
            white-space: nowrap;}

        /* åŒåˆ—å¸ƒå±€ */
        .split-panel {display: grid;grid-template-columns: 340px 1fr;gap: 1.5rem;}

        /* å·¦ä¾§æ§åˆ¶å° */
        .control-panel {background: rgba(10, 14, 23, 0.7);border-radius: 1.5rem;
            padding: 1.2rem 1rem;backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            max-height: 500px;overflow-y: auto;
            scrollbar-width: thin;}
        .panel-header {display: flex;justify-content: space-between;
            align-items: center;margin-bottom: 1rem;}
        .panel-header h3 {color: var(--theme-text);font-size: 0.95rem;
            font-weight: 600;text-transform: uppercase;}
        .add-module-btn {background: var(--theme-primary);border: none;
            color: white;width: 32px;height: 32px;border-radius: 50%;
            font-size: 1.3rem;cursor: pointer;border: 1px solid var(--theme-accent);
            flex-shrink: 0;display: flex;align-items: center;justify-content: center;}

        /* æ¨¡å—å¡ç‰‡ */
        .module-card {background: var(--theme-card-bg);border-radius: 1.2rem;
            padding: 1rem;margin-bottom: 1rem;border: 1px solid var(--theme-border);}
        .module-header {display: flex;align-items: center;
            justify-content: space-between;margin-bottom: 0.6rem;
            color: var(--theme-text);font-size: 0.75rem;font-weight: 600;}
        .module-actions button {background: var(--theme-primary);
            border: none;color: white;font-size: 1rem;
            width: 26px;height: 26px;border-radius: 30px;cursor: pointer;
            border: 1px solid var(--theme-accent);display: flex;
            align-items: center;justify-content: center;}
        .input-field {margin-bottom: 0.8rem;}
        .input-field label {color: var(--theme-text);opacity: 0.8;font-size: 0.65rem;
            display: block;margin-bottom: 0.1rem;}
        .input-field input, .input-field textarea {width: 100%;background: #0f1426;
            border: 1px solid var(--theme-border);border-radius: 16px;
            padding: 0.5rem 0.9rem;color: white;font-size: 0.85rem;
            outline: none;}
        .input-field textarea {min-height: 50px;resize: vertical;}

        /* é¢„è§ˆåŒº */
        .preview-with-export {display: flex;flex-direction: column;gap: 1rem;min-width: 300px;}
        .export-btn {background: var(--theme-primary);border: none;
            color: white;padding: 0.7rem 1.5rem;border-radius: 60px;
            font-size: 0.95rem;font-weight: 600;
            display: flex;align-items: center;justify-content: center;
            gap: 8px;cursor: pointer;border: 1px solid var(--theme-accent);
            width: 100%;max-width: 280px;margin: 0 auto;white-space: nowrap;}
        @media (min-width: 768px) {
            .export-btn {width: fit-content;margin-left: auto;margin-right: 0;}}
        .inbox-preview {background: linear-gradient(145deg, var(--theme-card-bg), #1a2038);
            border-radius: 1.8rem;padding: 1.5rem 1.2rem;
            border: 1px solid rgba(255,255,255,0.07);display: flex;
            flex-direction: column;width: 100%;min-width: 300px;}
        .preview-header {display: flex;align-items: center;justify-content: space-between;
            margin-bottom: 1.5rem;flex-wrap: wrap;gap: 0.5rem;}
        .inbox-icon h2 {color: var(--theme-text);font-size: 1.3rem;font-weight: 600;
            display: flex;align-items: center;gap: 6px;flex-wrap: wrap;}
        .inbox-icon span {background: var(--theme-primary);
            padding: 0.2rem 0.8rem;border-radius: 60px;color: white;
            font-size: 0.9rem;}
        .question-counter {background: var(--theme-card-bg);border-radius: 40px;
            padding: 0.2rem 1rem;color: var(--theme-text);
            border: 1px solid var(--theme-border);font-size: 0.85rem;white-space: nowrap;}
        .question-feed {flex: 1;display: flex;flex-direction: column;gap: 1rem;}
        .question-card {background: rgba(0, 0, 0, 0.3);border-radius: 1.5rem;
            padding: 1rem 1.2rem;border: 1px solid var(--theme-border);}
        .question-meta {display: flex;align-items: center;gap: 0.5rem;
            margin-bottom: 0.5rem;flex-wrap: wrap;}
        .anon-badge {background: var(--theme-primary);border-radius: 40px;
            padding: 0.2rem 0.8rem;font-size: 0.65rem;color: white;border: 1px solid var(--theme-accent);display: inline-flex;align-items: center;justify-content: center;height: 26px;
            line-height: 1;}
        .timestamp-display {background: var(--theme-card-bg);border: 1px solid var(--theme-border);border-radius: 30px;padding: 0.2rem 0.8rem;color: var(--theme-text);
            font-size: 0.65rem;display: inline-flex;align-items: center;justify-content: center;
            height: 26px;min-width: 90px;text-align: center;line-height: 1;
            white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
        .question-text {color: var(--theme-text);font-size: 0.95rem;
            margin-bottom: 0.8rem;word-break: break-word;}
        .answer-box {background: rgba(0, 0, 0, 0.25);border-radius: 1rem;
            padding: 0.8rem 1rem;border-left: 4px solid var(--theme-accent);
            color: var(--theme-text);word-break: break-word;font-size: 0.9rem;}
        .answer-fullname {font-weight: 600;color: var(--theme-accent);margin-right: 6px;}
        .ask-bar {margin-top: 1.5rem;background: rgba(10, 14, 27, 0.8);
            border-radius: 3rem;padding: 0.3rem 0.3rem 0.3rem 1.2rem;
            display: flex;align-items: center;justify-content: space-between;
            border: 1px solid var(--theme-border);}
        .ask-bar p {color: var(--theme-text);font-size: 0.85rem;}
        .fake-button {background: var(--theme-primary);padding: 0.4rem 1.2rem;
            border-radius: 3rem;color: white;border: 1px solid var(--theme-accent);
            font-size: 0.85rem;white-space: nowrap;}
        .empty-feed {padding: 1.5rem;text-align: center;color: var(--theme-text);
            border: 2px dashed var(--theme-border);border-radius: 1.5rem;font-size: 0.9rem;}
        .hidden {display: none !important;}

        /* åº•éƒ¨æ ‡æ³¨ */
        .footer-credit {margin-top: 1.2rem;text-align: center;font-size: 0.65rem;
            color: var(--theme-text);opacity: 0.5;letter-spacing: 0.3px;border-top: 1px dashed var(--theme-border);padding-top: 0.8rem;}

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .split-panel {grid-template-columns: 1fr;gap: 1.2rem;}
            .identity-row {flex-direction: column;align-items: flex-start;}
            .avatar-upload-area {width: 100%;justify-content: space-between;}
            .name-field {width: 100%;}
            .profile-card {flex-direction: column;align-items: flex-start;}
            .edit-signature {align-self: flex-end;}
            .theme-selector {flex-direction: column;align-items: flex-start;}
            .preview-header {flex-direction: column;align-items: flex-start;}
            
            /* ç¡®ä¿é¢„è§ˆåŒºåŸŸåœ¨ç§»åŠ¨ç«¯ä¹Ÿæœ‰è¶³å¤Ÿå®½åº¦ */
            .preview-with-export {min-width: 100%;}
            .inbox-preview {min-width: 100%;
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="generator theme-default" id="generatorRoot">
    <!-- èº«ä»½åŒºåŸŸ -->
    <div class="identity-section">
        <div class="identity-row">
            <div class="avatar-upload-area">
                <div class="avatar-preview" id="avatarPreview" style="background-image: none;">ğŸ“¸</div>
                <div class="upload-btn-wrapper">
                    â¬† ä¸Šä¼ å¤´åƒ
                    <input type="file" id="avatarUpload" accept="image/*">
                </div>
            </div>
            <div class="name-field">
                <label>è§’è‰²å (å®Œæ•´æ˜¾ç¤ºäºå›ç­”)</label>
                <input type="text" id="ocNameInput" placeholder="ä¾‹å¦‚ æ˜Ÿé‡ å…‰" value="è¿™é‡Œæ˜¯åå­—">
            </div>
        </div>

        <!-- ä¸»é¢˜é€‰æ‹©å™¨ -->
        <div class="theme-selector">
            <label>ğŸ¨ ä¸»é¢˜è‰²</label>
            <div class="theme-options">
                <div class="theme-chip chip-default selected" data-theme="default" title="é»˜è®¤ç´«"></div>
                <div class="theme-chip chip-ocean" data-theme="ocean" title="æµ·æ´‹"></div>
                <div class="theme-chip chip-forest" data-theme="forest" title="æ£®æ—"></div>
                <div class="theme-chip chip-sunset" data-theme="sunset" title="æ—¥è½"></div>
                <div class="theme-chip chip-midnight" data-theme="midnight" title="åˆå¤œ"></div>
            </div>
        </div>

        <!-- å¡ç‰‡å¼€å…³ -->
        <div class="profile-card-toggle">
            <div class="toggle-switch">
                <label>ğŸ“‹ æ˜¾ç¤ºè§’è‰²ä¿¡æ¯å¡ç‰‡</label>
                <input type="checkbox" id="toggleProfile" checked>
            </div>
        </div>

        <!-- è§’è‰²å¡ç‰‡ -->
        <div class="profile-card" id="profileCardForExport">
            <div class="profile-avatar-mini" id="profileAvatarMini" style="background-image: none;"></div>
            <div class="profile-text">
                <div class="profile-name" id="profileNameDisplay">è¿™é‡Œæ˜¯åå­—</div>
                <div class="profile-signature" id="signatureDisplay">è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹</div>
            </div>
            <button class="edit-signature" id="editSignatureBtn">âœ ç¼–è¾‘</button>
        </div>
    </div>

    <!-- åŒåˆ— -->
    <div class="split-panel">
        <!-- å·¦ä¾§æ¨¡å—ç®¡ç† -->
        <div class="control-panel">
            <div class="panel-header">
                <h3>ğŸ“¦ æé—®æ¨¡å— Â· è‡ªé€‰å¢å‡</h3>
                <button class="add-module-btn" id="addModuleBtn">+</button>
            </div>
            <div id="modulesContainer"></div>
        </div>
        <div class="preview-with-export">
            <button class="export-btn" id="exportPNGBtn">ğŸ“¸ å¯¼å‡ºPNG (è‡ªé€‚åº”é•¿åº¦)</button>
            <div class="inbox-preview" id="inboxPreviewForExport">
                <div class="preview-header">
                    <div class="inbox-icon">
                        <h2>ğŸ“¬ åŒ¿åç®± <span id="previewOCName">è¿™é‡Œæ˜¯åå­—</span></h2>
                    </div>
                    <div class="question-counter" id="counterDisplay">0 æ¡æé—®</div>
                </div>
                <div class="question-feed" id="questionFeed"></div>
                <div class="ask-bar">
                    <p>å‘ <span id="askBarName">è¿™é‡Œæ˜¯åå­—</span> åŒ¿åæé—®...</p>
                    <div class="fake-button">å‘é€</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ ‡æ³¨ -->
    <div class="footer-credit">
        å·¥å…·åˆ¶ä½œï¼š@æ‘é‡Œæœ€ä¹±ç‚’çš„åå¨
    </div>
</div>
<script>
    (function() {
        // æ¨¡å—æ•°æ®
        let modules = [];
        function genId() {
            return 'mod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
        }
        function initModules() {
            modules = [
                { id: genId(), question: 'å¦‚æœä½ èƒ½å˜æˆåŠ¨ç‰©ï¼Œæƒ³å˜æˆä»€ä¹ˆï¼Ÿ', answer: 'å¤§æ¦‚ä¼šé€‰çŒ«å¤´é¹°ã€‚å› ä¸ºå¯ä»¥åœ¨å¤œé‡Œæ€è€ƒå“²å­¦ã€‚', time: '2åˆ†é’Ÿå‰' },
                { id: genId(), question: 'æœ€è¿‘å•æ›²å¾ªç¯çš„ä¸€é¦–æ­Œæ˜¯ï¼Ÿ', answer: 'ã€ŠLemonã€‹æˆ–è€…å¾·å½ªè¥¿çš„æœˆå…‰ã€‚å¤å…¸ä¹è®©äººå¹³é™ã€‚', time: 'æ˜¨å¤© 23:14' },
                { id: genId(), question: 'å¯¹â€œä»£é¤â€çš„ç†è§£ï¼Ÿ', answer: 'åƒæœˆäº®ä¸å…­ä¾¿å£«ï¼ŒæŠ¬å¤´çœ‹æœˆäº®çš„æ—¶å€™ï¼Œå¶å°”ä¹Ÿéœ€è¦é¢åŒ…ã€‚', time: '15:32' }
            ];
        }
        initModules();

        // DOM å…ƒç´ 
        const ocNameInput = document.getElementById('ocNameInput');
        const previewOCName = document.getElementById('previewOCName');
        const askBarName = document.getElementById('askBarName');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarUpload = document.getElementById('avatarUpload');
        const modulesContainer = document.getElementById('modulesContainer');
        const questionFeed = document.getElementById('questionFeed');
        const counterDisplay = document.getElementById('counterDisplay');
        const addModuleBtn = document.getElementById('addModuleBtn');
        const toggleProfile = document.getElementById('toggleProfile');
        const profileCard = document.getElementById('profileCardForExport');
        const profileNameDisplay = document.getElementById('profileNameDisplay');
        const signatureDisplay = document.getElementById('signatureDisplay');
        const profileAvatarMini = document.getElementById('profileAvatarMini');
        const editSignatureBtn = document.getElementById('editSignatureBtn');
        const generatorRoot = document.getElementById('generatorRoot');
        const themeChips = document.querySelectorAll('.theme-chip');

        // ç­¾åç¼–è¾‘
        let currentSignature = 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹';
        editSignatureBtn.addEventListener('click', () => {
            const newSig = prompt('ç¼–è¾‘ä¸ªæ€§ç­¾å / è®¾å®š', currentSignature);
            if (newSig !== null) {currentSignature = newSig || ' ';
                signatureDisplay.textContent = currentSignature;}});

        // åˆ‡æ¢å¡ç‰‡æ˜¾ç¤º
        toggleProfile.addEventListener('change', (e) => {
            if (e.target.checked) {profileCard.classList.remove('hidden');
            } else {profileCard.classList.add('hidden');}});

        // ä¸»é¢˜åˆ‡æ¢
        themeChips.forEach(chip => {
            chip.addEventListener('click', () => {
                themeChips.forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
                const theme = chip.dataset.theme;
                generatorRoot.className = `generator theme-${theme}`;
            });
        });

        // æ›´æ–°å¡ç‰‡
        function updateProfileCard() {const name = ocNameInput.value.trim() || 'è¿™é‡Œæ˜¯åå­—';
            profileNameDisplay.textContent = name;
            const bg = avatarPreview.style.backgroundImage;
            if (bg && bg !== 'none') {profileAvatarMini.style.backgroundImage = bg;
                profileAvatarMini.style.backgroundColor = 'transparent';
            } else {profileAvatarMini.style.backgroundImage = 'none';
                profileAvatarMini.style.backgroundColor = 'var(--theme-primary)';}
        }

        // å¤´åƒä¸Šä¼ 
        avatarUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {const reader = new FileReader();reader.onload = function(ev) {
                    avatarPreview.style.backgroundImage = `url('${ev.target.result}')`;
                    avatarPreview.style.backgroundColor = 'transparent';
                    avatarPreview.textContent = '';
                    updateProfileCard();};
                reader.readAsDataURL(file);}
        });

        // åå­—æ›´æ–°
        ocNameInput.addEventListener('input', () => {
            renderPreview();
            updateProfileCard();});

        // è½¬ä¹‰
        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/[&<>"]/g, function(c) {
                if(c === '&') return '&amp;'; if(c === '<') return '&lt;'; if(c === '>') return '&gt;'; if(c === '"') return '&quot;';
                return c;});}

        // æ¸²æŸ“å·¦ä¾§æ¨¡å—
        function renderModules() {
            let html = '';
            modules.forEach((mod, idx) => {
                html += `
                    <div class="module-card" data-id="${mod.id}">
                        <div class="module-header">
                            <span>ğŸ“Œ #${idx+1}</span>
                            <div class="module-actions">
                                <button class="delete-module" data-id="${mod.id}">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="input-field">
                            <label>åŒ¿åæé—®</label>
                            <input type="text" class="module-question" data-id="${mod.id}" value="${escapeHtml(mod.question)}">
                        </div>
                        <div class="input-field">
                            <label>OC å›ç­”</label>
                            <textarea class="module-answer" data-id="${mod.id}" rows="2">${escapeHtml(mod.answer)}</textarea>
                        </div>
                        <div class="input-field">
                            <label>â±ï¸ è‡ªå®šä¹‰æ—¶é—´</label>
                            <input type="text" class="module-time" data-id="${mod.id}" value="${escapeHtml(mod.time || 'åˆšåˆš')}" placeholder="ä¾‹å¦‚ æ˜¨å¤© 20:00">
                        </div>
                    </div>
                `;
            });
            modulesContainer.innerHTML = html;
            document.querySelectorAll('.module-question').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const id = e.target.dataset.id;
                    const m = modules.find(m => m.id === id);
                    if (m) { m.question = e.target.value; renderPreview(); }});
            });
            document.querySelectorAll('.module-answer').forEach(ta => {
                ta.addEventListener('input', (e) => {const id = e.target.dataset.id;
                    const m = modules.find(m => m.id === id);
                    if (m) { m.answer = e.target.value; renderPreview(); }});});
            document.querySelectorAll('.module-time').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const id = e.target.dataset.id;
                    const m = modules.find(m => m.id === id);
                    if (m) { m.time = e.target.value; renderPreview(); }});});
            document.querySelectorAll('.delete-module').forEach(btn => {
                btn.addEventListener('click', (e) => {const id = e.target.dataset.id;
                    modules = modules.filter(m => m.id !== id);
                    renderModules();renderPreview();});});}

        // æ¸²æŸ“é¢„è§ˆ
        function renderPreview() {
            const name = ocNameInput.value.trim() || 'è¿™é‡Œæ˜¯åå­—';
            previewOCName.textContent = name;
            askBarName.textContent = name;
            counterDisplay.textContent = modules.length + ' æ¡æé—®';
            let feedHtml = '';
            if (modules.length === 0) {
                feedHtml = '<div class="empty-feed">âœ¨ å·¦ä¾§æ·»åŠ æé—®æ¨¡å—</div>';
            } else {
                modules.forEach(m => {
                    const q = m.question || '...';
                    const a = m.answer || '...';
                    const t = m.time || 'åˆšåˆš';
                    feedHtml += `
                        <div class="question-card">
                            <div class="question-meta">
                                <span class="anon-badge">åŒ¿åå›</span>
                                <span class="timestamp-display" title="${escapeHtml(t)}">${escapeHtml(t)}</span>
                            </div>
                            <div class="question-text">${escapeHtml(q)}</div>
                            <div class="answer-box">
                                <span class="answer-fullname">${escapeHtml(name)}</span> ${escapeHtml(a)}
                            </div>
                        </div>
                    `;
                });
            }
            questionFeed.innerHTML = feedHtml;
        }
        addModuleBtn.addEventListener('click', () => {
            const newMod = {id: genId(),question: 'æ–°çš„åŒ¿åæé—®',answer: 'æ–°å›ç­”â€¦â€¦',
                time: 'åˆšåˆš'};
            modules.push(newMod);
            renderModules();
            renderPreview();});

        // å¤´åƒåŒå‡»æ¸…é™¤
        avatarPreview.addEventListener('dblclick', () => {
            avatarPreview.style.backgroundImage = 'none';
            avatarPreview.style.backgroundColor = '';
            avatarPreview.textContent = 'ğŸ“¸';
            updateProfileCard();});

        // å¯¼å‡ºPNG
        const exportBtn = document.getElementById('exportPNGBtn');
        async function exportAsPNG() {
            const profileCardEl = document.getElementById('profileCardForExport');
            const inboxEl = document.getElementById('inboxPreviewForExport');
            const toggleCheckbox = document.getElementById('toggleProfile');
            const editBtn = document.getElementById('editSignatureBtn');
            const identityRow = document.querySelector('.identity-row');
            const toggleDiv = document.querySelector('.profile-card-toggle');
            const themeSelector = document.querySelector('.theme-selector');

            // ä¿å­˜éœ€è¦éšè—çš„å…ƒç´ 
            const elementsToHide = [identityRow, toggleDiv, themeSelector, editBtn];
            const hiddenStates = elementsToHide.map(el => el.style.display);
            elementsToHide.forEach(el => el.style.display = 'none');
            const isCardVisible = toggleCheckbox.checked;

            // è·å–é¢„è§ˆåŒºåŸŸçš„å®é™…å®½åº¦
            const previewWidth = inboxEl.offsetWidth;
            
            // åˆ›å»ºä¸´æ—¶åŒ…è£¹å®¹å™¨
            const wrapper = document.createElement('div');
            wrapper.style.backgroundColor = '#0f1424';
            wrapper.style.padding = '1.5rem';
            wrapper.style.borderRadius = '2rem';
            wrapper.style.display = 'inline-block';
            wrapper.style.position = 'absolute';
            wrapper.style.left = '-9999px';
            wrapper.style.top = '0';
            wrapper.style.zIndex = '10000';
            
            // è®¾ç½®å›ºå®šå®½åº¦ï¼Œç¡®ä¿æ‰‹æœºç«¯å¯¼å‡ºå›¾ç‰‡å®½åº¦ä¸ç”µè„‘ç«¯ä¸€è‡´
            // ä½¿ç”¨Math.maxç¡®ä¿å®½åº¦è‡³å°‘ä¸º400pxï¼Œé¿å…å¤ªçª„
            const targetWidth = Math.max(previewWidth, 400);
            wrapper.style.width = targetWidth + 'px';
            if (isCardVisible) {const cardClone = profileCardEl.cloneNode(true);
                const cloneEdit = cardClone.querySelector('.edit-signature');
                if (cloneEdit) cloneEdit.style.display = 'none';
                cardClone.classList.remove('hidden');
                // ç¡®ä¿å¡ç‰‡å®½åº¦é€‚åº”å®¹å™¨
                cardClone.style.width = '100%';
                wrapper.appendChild(cardClone);}
            const inboxClone = inboxEl.cloneNode(true);
            // ç¡®ä¿å…‹éš†çš„é¢„è§ˆåŒºåŸŸå®½åº¦é€‚åº”å®¹å™¨
            inboxClone.style.width = '100%';
            wrapper.appendChild(inboxClone);
            document.body.appendChild(wrapper);
            try {const canvas = await html2canvas(wrapper, {scale: 2,
                    backgroundColor: '#0f1424',allowTaint: false,
                    useCORS: true,logging: false,windowWidth: targetWidth,
                    windowHeight: wrapper.scrollHeight,width: targetWidth,
                    height: wrapper.scrollHeight});
                const link = document.createElement('a');
                link.download = `oc-æé—®ç®±-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(wrapper);
                elementsToHide.forEach((el, idx) => el.style.display = hiddenStates[idx]);
            } catch (err) {
                alert('å¯¼å‡ºå¤±è´¥ï¼Œå¯ç¨åé‡è¯•ã€‚');
                document.body.removeChild(wrapper);
                elementsToHide.forEach((el, idx) => el.style.display = hiddenStates[idx]);
            }
        }
        exportBtn.addEventListener('click', exportAsPNG);

        // åˆå§‹åŒ–
        renderModules();
        renderPreview();
        updateProfileCard();
    })();
</script>
</body>
</html>